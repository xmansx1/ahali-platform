{% extends "core/base.html" %}
{% block title %}إعدادات المتجر{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto p-6 bg-white rounded-xl shadow">
  <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">⚙️ إعدادات المتجر</h2>

  {% if messages %}
    <div class="mb-4 space-y-2">
      {% for msg in messages %}
        <div class="px-4 py-2 rounded shadow text-sm {% if msg.tags == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-700{% endif %}">
          {{ msg }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ✅ نموذج تحديث بيانات المتجر -->
  <form method="POST" action="" class="space-y-5 mb-10">
    {% csrf_token %}

    <!-- رقم الجوال -->
    <div>
      <label class="block mb-1 text-sm font-medium text-gray-700">📱 رقم الجوال</label>
      {{ form.phone }}
    </div>

    <!-- العنوان النصي -->
    <div>
      <label class="block mb-1 text-sm font-medium text-gray-700">📍 عنوان المتجر</label>
      {{ form.address }}
    </div>

    <!-- الخريطة -->
    <div>
      <label class="block mb-1 text-sm font-medium text-gray-700">🗺️ تحديد الموقع على الخريطة</label>
      <div id="map" class="rounded border h-72"></div>
    </div>

    {{ form.latitude }}
    {{ form.longitude }}

    <!-- ✅ checkbox متاح لاستقبال الطلبات -->
    <div class="flex items-center gap-2">
      <input type="hidden" name="is_available" value="off">
      <input type="checkbox"
             id="id_is_available"
             name="is_available"
             value="on"
             {% if form.instance.is_available %}checked{% endif %}
             class="h-4 w-4 text-green-600 border-gray-300 rounded">
      <label for="id_is_available" class="text-sm text-gray-700">متاح لاستقبال الطلبات</label>
    </div>

    <!-- زر الحفظ -->
    <button type="submit" name="save_settings" value="1"
            class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded font-medium">
      💾 حفظ التغييرات
    </button>
  </form>

  <hr class="my-8">

  <!-- ✅ تغيير كلمة المرور -->
  <h3 class="text-xl font-semibold text-gray-800 mb-4">🔒 تغيير كلمة المرور</h3>
  <form method="POST" action="">
    {% csrf_token %}
    <input type="hidden" name="change_password" value="1">
    {{ pass_form.non_field_errors }}

    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور الحالية</label>
        {{ pass_form.old_password }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور الجديدة</label>
        {{ pass_form.new_password }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">تأكيد كلمة المرور</label>
        {{ pass_form.confirm_password }}
      </div>
    </div>

    <button type="submit" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded font-medium">
      🔐 تحديث كلمة المرور
    </button>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Leaflet Map -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const latInput = document.getElementById("id_latitude");
    const lngInput = document.getElementById("id_longitude");

    const defaultLat = parseFloat(latInput.value || 24.7136);
    const defaultLng = parseFloat(lngInput.value || 46.6753);

    const map = L.map('map').setView([defaultLat, defaultLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);

    marker.on('dragend', function () {
      const { lat, lng } = marker.getLatLng();
      latInput.value = lat.toFixed(6);
      lngInput.value = lng.toFixed(6);
    });

    map.on('click', function (e) {
      marker.setLatLng(e.latlng);
      latInput.value = e.latlng.lat.toFixed(6);
      lngInput.value = e.latlng.lng.toFixed(6);
    });
  });
</script>
{% endblock %}
