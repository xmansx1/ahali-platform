{% extends "core/base.html" %}

{% block title %}Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto p-6 bg-white rounded-xl shadow">
  <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±</h2>

  {% if messages %}
  <div class="mb-4 space-y-2">
    {% for msg in messages %}
    <div class="px-4 py-2 rounded shadow text-sm {% if msg.tags == 'success' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-700{% endif %}">
      {{ msg }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <form method="POST" action="" class="space-y-5 mb-10">
    {% csrf_token %}

    <!-- Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ -->
    <div>
      <label class="block mb-1 text-sm font-medium text-gray-700">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
      {{ form.phone }}
    </div>

    <!-- Ù…Ø¨Ù„Øº Ø§Ù„ØªÙˆØµÙŠÙ„ -->
    <div>
      <label class="block mb-1 text-sm font-medium text-gray-700">ğŸšš Ù…Ø¨Ù„Øº Ø§Ù„ØªÙˆØµÙŠÙ„ (Ø±ÙŠØ§Ù„)</label>
      {{ form.delivery_fee }}
      <p class="mt-2 text-xs text-yellow-700 bg-yellow-100 border border-yellow-200 px-3 py-2 rounded shadow-sm">
        âš ï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØªÙˆØµÙŠÙ„ Ù‡Ùˆ <strong>10 Ø±ÙŠØ§Ù„</strong>.
      </p>
    </div>

    <!-- Ù†Ø³Ø¨Ø© ÙŠØªØ­Ù…Ù„Ù‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
    <div>
      <label class="block mb-1 text-sm font-medium text-gray-700">ğŸ§® Ù†Ø³Ø¨Ø© ÙŠØªØ­Ù…Ù„Ù‡Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªÙˆØµÙŠÙ„ (%)</label>
      {{ form.customer_delivery_share }}
      <p class="text-xs text-gray-500 mt-1">Ù…Ø«Ø§Ù„: 40 ØªØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØªØ­Ù…Ù„ 40% Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„.</p>
      <p class="mt-2 text-xs text-blue-700 bg-blue-50 border border-blue-200 px-3 py-2 rounded shadow-sm">
        â„¹ï¸ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù†Ø³Ø¨Ø© Ø¨ÙŠÙ† <strong>0%</strong> Ùˆ <strong>100%</strong>.
      </p>
      <p id="customer-fee-preview" class="mt-2 text-sm text-gray-600">
        ğŸšš Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØªØ­Ù…Ù„: <span id="calculated-fee">--</span> Ø±ÙŠØ§Ù„
      </p>
    </div>

    <!-- Ø³ÙŠØ§Ø³Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ -->
    <div>
      <label class="block mb-1 text-sm font-medium text-gray-700">ğŸ“¢ Ø³ÙŠØ§Ø³Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</label>
      {{ form.delivery_policy_note }}
      <p class="text-xs text-gray-500 mt-1">
        Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙˆÙŠÙØ¹Ø±Ø¶ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù†Ø¯ ØªØµÙØ­ Ø§Ù„Ù…ØªØ¬Ø±. Ù…Ø«Ø§Ù„:
        <br><span class="text-green-700">ğŸšš Ø§Ù„ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª ÙÙˆÙ‚ 50 Ø±ÙŠØ§Ù„</span>
      </p>
    </div>

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ¬Ø± -->
    <div>
      <label class="block mb-1 text-sm font-medium text-gray-700">ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ¬Ø±</label>
      {{ form.address }}
    </div>

    <!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
    <div>
      <label class="block mb-1 text-sm font-medium text-gray-700">ğŸ—ºï¸ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
      <div id="map" class="rounded border h-72"></div>
    </div>

    {{ form.latitude }}
    {{ form.longitude }}

    <!-- Ø­Ø§Ù„Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <div class="flex items-center gap-2">
      <input type="hidden" name="is_available" value="off">
      <input type="checkbox" id="id_is_available" name="is_available" value="on"
             {% if form.instance.is_available %}checked{% endif %}
             class="h-4 w-4 text-green-600 border-gray-300 rounded">
      <label for="id_is_available" class="text-sm text-gray-700">ğŸ“¦ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØªØ§Ø­ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</label>
    </div>

    <button type="submit" name="save_settings" value="1"
            class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded font-medium">
      ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
    </button>
  </form>

  <hr class="my-8">

  <h3 class="text-xl font-semibold text-gray-800 mb-4">ğŸ”’ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
  <form method="POST" action="">
    {% csrf_token %}
    <input type="hidden" name="change_password" value="1">
    {{ pass_form.non_field_errors }}

    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
        {{ pass_form.old_password }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
        {{ pass_form.new_password }}
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        {{ pass_form.confirm_password }}
      </div>
    </div>

    <button type="submit"
            class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded font-medium">
      ğŸ” ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    </button>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const latInput = document.getElementById("id_latitude");
    const lngInput = document.getElementById("id_longitude");
    const defaultLat = parseFloat(latInput.value || 24.7136);
    const defaultLng = parseFloat(lngInput.value || 46.6753);
    const map = L.map("map").setView([defaultLat, defaultLng], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);
    const marker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(map);
    marker.on("dragend", function () {
      const { lat, lng } = marker.getLatLng();
      latInput.value = lat.toFixed(6);
      lngInput.value = lng.toFixed(6);
    });
    map.on("click", function (e) {
      marker.setLatLng(e.latlng);
      latInput.value = e.latlng.lat.toFixed(6);
      lngInput.value = e.latlng.lng.toFixed(6);
    });

    // Ø­Ø³Ø§Ø¨ Ø±Ø³ÙˆÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
    function calculateCustomerFee() {
      const feeInput = document.getElementById("id_delivery_fee");
      const shareInput = document.getElementById("id_customer_delivery_share");
      const output = document.getElementById("calculated-fee");
      const fee = parseFloat(feeInput.value);
      const share = parseFloat(shareInput.value);
      if (!isNaN(fee) && !isNaN(share)) {
        const customerFee = Math.round((fee * share) / 100);
        output.textContent = customerFee;
      } else {
        output.textContent = "--";
      }
    }

    const feeInput = document.getElementById("id_delivery_fee");
    const shareInput = document.getElementById("id_customer_delivery_share");
    if (feeInput && shareInput) {
      feeInput.addEventListener("input", calculateCustomerFee);
      shareInput.addEventListener("input", calculateCustomerFee);
      calculateCustomerFee();
    }
  });
</script>
{% endblock %}
