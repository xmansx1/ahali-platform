{% extends "core/base.html" %}
{% block title %}طلباتي الحالية{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-xl shadow p-6 mb-10">
  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">📦 طلباتي الحالية</h2>

  {% if messages %}
    <div class="mb-4 space-y-2">
      {% for message in messages %}
        <div class="bg-green-100 text-green-800 px-4 py-2 rounded shadow text-sm">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% for order in orders %}
    <div class="border border-gray-200 rounded-xl shadow-sm p-5 mb-6 bg-gray-50 hover:bg-gray-100 transition-all duration-200">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700 leading-relaxed">

        <div>
          <p><strong>👤 العميل:</strong> {{ order.customer_name }}</p>
          {% if order.customer_phone %}
            <p class="text-gray-600 text-xs mt-1">{{ order.customer_phone }}</p>
          {% endif %}
        </div>

        <p><strong>💵 المبلغ:</strong> {{ order.invoice_amount|default:"-" }} ريال</p>
        <p><strong>📝 تفاصيل الطلب:</strong> {{ order.details }}</p>

        <p class="flex items-center gap-1">
          <strong>📍 موقع العميل:</strong>
          {% if order.customer_latitude and order.customer_longitude %}
            <a href="https://www.google.com/maps?q={{ order.customer_latitude }},{{ order.customer_longitude }}"
               target="_blank" class="text-blue-600 hover:underline"
               title="فتح موقع العميل على خرائط Google">
              🔗 انتقل
            </a>
          {% else %}
            <span class="text-gray-500">غير متوفر</span>
          {% endif %}
        </p>

        <p class="flex items-center gap-1">
          <strong>📌 موقع المتجر:</strong>
          {% if order.store_latitude and order.store_longitude %}
            <a href="https://www.google.com/maps?q={{ order.store_latitude }},{{ order.store_longitude }}"
               target="_blank" class="text-blue-600 hover:underline"
               title="فتح موقع المتجر على خرائط Google">
              🔗 انتقل
            </a>
          {% else %}
            <span class="text-gray-500">غير محدد</span>
          {% endif %}
        </p>

        <p>
          <strong>🏪 المتجر:</strong>
          {{ order.store.name|default:"اسم غير متوفر" }}
          {% if order.store.user.username %}
            <span class="text-gray-600 text-xs">({{ order.store.user.username }})</span>
          {% endif %}
        </p>
      </div>

      <!-- ✅ الإجراءات -->
      <div class="flex flex-wrap gap-3 mt-5">
        <a href="{% url 'complete_order' order.id %}"
           class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm transition">
          ✅ تم التوصيل
        </a>

        {% if order.customer_phone %}
          <a href="tel:{{ order.customer_phone }}"
             class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition">
            📞 اتصال
          </a>

          <a href="https://wa.me/{{ order.customer_phone|slice:'-9:' }}"
             target="_blank"
             class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition">
            💬 واتساب
          </a>
        {% endif %}

        {% if order.customer_latitude and order.customer_longitude and order.store_latitude and order.store_longitude %}
          <button onclick="showMap({{ order.id }})"
                  class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm transition">
            🗺️ عرض الخريطة
          </button>
        {% else %}
          <span class="text-yellow-600 text-sm mt-2">
            ⚠️ لا يمكن عرض الخريطة (إحداثيات ناقصة)
          </span>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p class="text-center text-gray-500 mt-10">لا توجد طلبات حالياً قيد التوصيل.</p>
  {% endfor %}
</div>

<!-- ✅ Modal الخريطة -->
<div id="map-modal"
     class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl p-4 relative">
    <button onclick="closeMapModal()"
            class="absolute top-2 left-2 text-gray-600 hover:text-black text-xl">✕</button>
    <h3 class="text-lg font-semibold mb-3 text-gray-800">🗺️ خريطة الطلب</h3>
    <div id="map-container" class="h-72 rounded border"></div>
  </div>
</div>

<!-- ✅ JavaScript -->
<script>
  function showMap(orderId) {
    const order = window.ordersData[orderId];
    if (!order) return alert("لا توجد بيانات للطلب");

    document.getElementById("map-modal").classList.remove("hidden");

    if (window.mapInstance) {
      window.mapInstance.remove();
    }

    const map = L.map("map-container").setView([order.customer_latitude, order.customer_longitude], 13);
    window.mapInstance = map;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const clientIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/535/535239.png",
      iconSize: [30, 30],
      iconAnchor: [15, 30],
    });

    const storeIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/891/891462.png",
      iconSize: [30, 30],
      iconAnchor: [15, 30],
    });

    L.marker([order.customer_latitude, order.customer_longitude], { icon: clientIcon })
      .addTo(map).bindPopup("📍 موقع العميل");

    if (order.store_latitude && order.store_longitude) {
      L.marker([order.store_latitude, order.store_longitude], { icon: storeIcon })
        .addTo(map).bindPopup("🏪 موقع المتجر");
    }
  }

  function closeMapModal() {
    document.getElementById("map-modal").classList.add("hidden");
  }

  window.ordersData = {
    {% for order in orders %}
      {% if order.customer_latitude and order.customer_longitude %}
        {{ order.id }}: {
          customer_latitude: {{ order.customer_latitude }},
          customer_longitude: {{ order.customer_longitude }},
          {% if order.store_latitude and order.store_longitude %}
          store_latitude: {{ order.store_latitude }},
          store_longitude: {{ order.store_longitude }},
          {% endif %}
        },
      {% endif %}
    {% endfor %}
  };
</script>
{% endblock %}
