{% extends "core/base.html" %}
{% load static %}
{% load order_extras %}

{% block title %}Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-xl shadow p-4 sm:p-6 mb-10">
  <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ“¦ Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>

  {% if messages %}
    <div class="mb-4 space-y-2">
      {% for message in messages %}
        <div class="bg-green-100 text-green-800 px-4 py-2 rounded shadow text-sm">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% for order in orders %}
    <div class="border border-gray-200 rounded-xl shadow-sm p-4 sm:p-5 mb-6 bg-gray-50 hover:bg-gray-100 transition-all duration-200">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm sm:text-base text-gray-700 leading-relaxed">
        <div>
          <p><strong>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ order.customer_name }}</p>
          {% if order.customer_phone %}
            <p class="text-gray-600 text-xs mt-1 break-all">{{ order.customer_phone }}</p>
          {% endif %}
        </div>

        <div>
          <p><strong>ğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº:</strong> {{ order.invoice_amount|default:"-" }} Ø±ÙŠØ§Ù„</p>
        </div>

        <div class="sm:col-span-2">
          <p><strong>ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:</strong> {{ order.details }}</p>
        </div>

        <div>
          <p><strong>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong>
          {% if order.customer_latitude and order.customer_longitude %}
            <a href="https://www.google.com/maps?q={{ order.customer_latitude }},{{ order.customer_longitude }}" target="_blank" class="text-blue-600 hover:underline">ğŸ”— Ø§Ù†ØªÙ‚Ù„</a>
          {% else %}
            <span class="text-gray-500">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
          {% endif %}
          </p>
        </div>

        <div>
          <p><strong>ğŸ“Œ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ØªØ¬Ø±:</strong>
          {% if order.store_latitude and order.store_longitude %}
            <a href="https://www.google.com/maps?q={{ order.store_latitude }},{{ order.store_longitude }}" target="_blank" class="text-blue-600 hover:underline">ğŸ”— Ø§Ù†ØªÙ‚Ù„</a>
          {% else %}
            <span class="text-gray-500">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
          {% endif %}
          </p>
        </div>

        <div class="sm:col-span-2">
          <p>
            <strong>ğŸª Ø§Ù„Ù…ØªØ¬Ø±:</strong> {{ order.store.name|default:"Ø§Ø³Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±" }}
            {% if order.store.user.username %}
              <span class="text-gray-600 text-xs">({{ order.store.user.username }})</span>
            {% endif %}
          </p>
        </div>
      </div>

      <!-- âœ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
      <div class="flex flex-wrap gap-3 mt-5 text-sm">
        <a href="{% url 'complete_order' order.id %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
          âœ… ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„
        </a>

        {% if order.customer_phone %}
          <a href="tel:{{ order.customer_phone }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
            ğŸ“ Ø§ØªØµØ§Ù„
          </a>

          {% with order.customer_phone|whatsapp_number as whatsapp_number %}
            {% if whatsapp_number %}
              {% with order.store.name as store_name %}
              {% with order.invoice_amount|floatformat:2 as amount %}
                {% with "Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù…ØªØ¬Ø± "|add:store_name|add:" ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„ÙŠÙƒ ğŸšš.%0AØ§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ù…Ø¨Ù„Øº "|add:amount|add:" Ø±ÙŠØ§Ù„.%0AğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ÙƒØ§Ø´ / ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ / STCPay" as message %}
                  <a href="https://wa.me/{{ whatsapp_number }}?text={{ message|urlencode }}" target="_blank"
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                    ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨
                  </a>
                {% endwith %}
              {% endwith %}
              {% endwith %}
            {% else %}
              <span class="text-sm text-red-500">ğŸ“µ Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨</span>
            {% endif %}
          {% endwith %}
        {% endif %}

        {% if order.customer_latitude and order.customer_longitude and order.store_latitude and order.store_longitude %}
          <button onclick="openMapModal({{ order.store_latitude }}, {{ order.store_longitude }}, {{ order.customer_latitude }}, {{ order.customer_longitude }})"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition">
            ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
          </button>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p class="text-center text-gray-500 mt-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„.</p>
  {% endfor %}
</div>

<!-- âœ… Modal Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div id="mapModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 px-2">
  <div class="bg-white rounded-lg shadow-lg max-w-3xl w-full p-4 relative">
    <button onclick="closeMapModal()" class="absolute top-2 left-2 text-gray-600 hover:text-gray-800 text-xl">âœ–</button>
    <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">ğŸ—ºï¸ Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
    <div id="leafletMap" class="w-full h-80 sm:h-96 rounded-lg border"></div>
  </div>
</div>

<!-- âœ… Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let mapInstance = null;

  function openMapModal(storeLat, storeLng, customerLat, customerLng) {
    document.getElementById("mapModal").classList.remove("hidden");
    const mapContainer = document.getElementById("leafletMap");
    mapContainer.innerHTML = "";

    if (mapInstance !== null) {
      mapInstance.remove();
    }

    mapInstance = L.map("leafletMap").setView([storeLat, storeLng], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(mapInstance);

    L.marker([storeLat, storeLng])
      .addTo(mapInstance)
      .bindPopup("ğŸª Ø§Ù„Ù…ØªØ¬Ø±")
      .openPopup();

    L.marker([customerLat, customerLng])
      .addTo(mapInstance)
      .bindPopup("ğŸ“ Ø§Ù„Ø¹Ù…ÙŠÙ„");

    const route = L.polyline(
      [
        [storeLat, storeLng],
        [customerLat, customerLng],
      ],
      { color: "blue" }
    ).addTo(mapInstance);

    mapInstance.fitBounds(route.getBounds(), { padding: [50, 50] });
  }

  function closeMapModal() {
    document.getElementById("mapModal").classList.add("hidden");
  }
</script>
{% endblock %}
