{% extends "core/base.html" %}
{% block title %}Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªÙˆØµÙŠÙ„{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
  <!-- âœ… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ Ø±Ø§Ø¨Ø· Ù…Ø³ØªØ­Ù‚Ø§ØªÙŠ -->
  <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
    <h2 class="text-3xl font-extrabold flex items-center gap-3 text-gray-800">
      ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªÙˆØµÙŠÙ„
    </h2>
    <a href="{% url 'delivery_earnings' %}"
       class="inline-flex items-center gap-2 bg-green-100 text-green-800 font-semibold text-sm px-4 py-2 rounded-lg shadow hover:bg-green-200 transition">
 
      ğŸ’° Ù…Ø³ØªØ­Ù‚Ø§ØªÙŠ
    </a>
  </div>

  <!-- âœ… Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… -->
  {% if messages %}
    <div class="mb-6 space-y-2">
      {% for message in messages %}
        <div class="bg-green-100 text-green-800 px-4 py-2 rounded shadow text-sm">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- âœ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
  {% if orders %}
    <div class="grid gap-6">
      {% for order in orders %}
        <div class="bg-white border border-gray-200 rounded-xl shadow hover:shadow-md transition-all duration-300 p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700 leading-relaxed">
            <p><strong>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ order.customer_name }}
              {% if order.customer_phone %}
                <br><span class="text-gray-500 text-xs">ğŸ“± {{ order.customer_phone }}</span>
              {% endif %}
            </p>
            <p><strong>ğŸ›ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:</strong> {{ order.details }}</p>
            <p>
              <strong>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong>
              {% if order.latitude and order.longitude %}
                <a href="https://www.google.com/maps?q={{ order.latitude }},{{ order.longitude }}" target="_blank"
                   class="text-blue-600 hover:underline inline-flex items-center gap-1">
                  ğŸ”— Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„
                </a>
              {% else %}
                <span class="text-gray-400">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
              {% endif %}
            </p>
            <p>
              <strong>ğŸª Ø§Ù„Ù…ØªØ¬Ø±:</strong> {{ order.store.name }}<br>
              <span class="text-gray-500 text-xs">{{ order.store.address|default:"ØºÙŠØ± Ù…ØªÙˆÙØ±" }}</span><br>
              {% if order.store.latitude and order.store.longitude %}
                <a href="https://www.google.com/maps?q={{ order.store.latitude }},{{ order.store.longitude }}" target="_blank"
                   class="text-purple-600 hover:underline inline-flex items-center gap-1 mt-1">
                  ğŸ”— Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ØªØ¬Ø±
                </a>
              {% endif %}
            </p>
            <p><strong>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº:</strong> {{ order.invoice_amount|default:"-" }} Ø±ÙŠØ§Ù„</p>
          </div>
          <p><strong>ğŸ’µ Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> {{ order.delivery_fee|default:"-" }} Ø±ÙŠØ§Ù„</p>

          <!-- âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ -->
          <div class="flex flex-col sm:flex-row justify-between items-center mt-6 gap-4">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="order_id" value="{{ order.id }}">
              <button type="submit"
                      class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm transition flex items-center gap-2">
                ğŸšš Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªÙˆØµÙŠÙ„
              </button>
            </form>

            {% if order.latitude and order.longitude and order.store.latitude and order.store.longitude %}
              <button type="button" onclick="showMap({{ order.id }})"
                      class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm transition flex items-center gap-2">
                ğŸ—ºï¸ Ø§Ø¹Ø±Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹
              </button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500 text-center mt-12 text-lg">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
  {% endif %}
</div>

<!-- âœ… Modal Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div id="map-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl p-4 relative">
    <button onclick="closeMapModal()" class="absolute top-2 left-2 text-gray-600 hover:text-black text-xl">âœ•</button>
    <h3 class="text-lg font-semibold mb-3 text-gray-800">ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
    <div id="map-container" class="h-72 rounded border"></div>
  </div>
</div>

<!-- âœ… JavaScript Ù„Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« -->
<script>
  function showMap(orderId) {
    reloadEnabled = false;
    const order = window.ordersData[orderId];
    if (!order) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ù„Ø¨");

    document.getElementById("map-modal").classList.remove("hidden");

    if (window.mapInstance) window.mapInstance.remove();

    const map = L.map("map-container").setView([order.customer_latitude, order.customer_longitude], 13);
    window.mapInstance = map;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const clientIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/535/535239.png",
      iconSize: [30, 30],
      iconAnchor: [15, 30],
    });

    const storeIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/891/891462.png",
      iconSize: [30, 30],
      iconAnchor: [15, 30],
    });

    L.marker([order.customer_latitude, order.customer_longitude], { icon: clientIcon })
      .addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„").openPopup();

    if (order.store_latitude && order.store_longitude) {
      L.marker([order.store_latitude, order.store_longitude], { icon: storeIcon })
        .addTo(map).bindPopup("ğŸª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ØªØ¬Ø±");
    }
  }

  function closeMapModal() {
    document.getElementById("map-modal").classList.add("hidden");
    reloadEnabled = true;
  }

  // âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø®Ø±ÙŠØ·Ø©
  window.ordersData = {
    {% for order in orders %}
      {% if order.latitude and order.longitude %}
        {{ order.id }}: {
          customer_latitude: {{ order.latitude }},
          customer_longitude: {{ order.longitude }},
          store_latitude: {{ order.store.latitude|default:"null" }},
          store_longitude: {{ order.store.longitude|default:"null" }},
        },
      {% endif %}
    {% endfor %}
  };

  // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙƒÙ„ 20 Ø«Ø§Ù†ÙŠØ©
  let reloadEnabled = true;
  setInterval(() => {
    if (reloadEnabled) window.location.reload();
  }, 20000);
</script>
{% endblock %}
