{% extends "core/base.html" %}
{% block title %}Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 bg-white rounded-xl shadow-md">

  <!-- âœ… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
    ğŸ“ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØµÙ„Ø©
  </h2>

  <!-- âœ… ÙƒØ±Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  <div class="mb-6">
    <div class="bg-green-100 border border-green-300 text-green-800 rounded-xl px-5 py-4 shadow-sm flex items-center justify-between">
      <div class="text-lg font-semibold">âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØµÙ„Ø©:</div>
      <div class="text-2xl font-bold">{{ orders|length }}</div>
    </div>
  </div>

  <!-- âœ… ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® -->
  <form method="get" class="flex flex-wrap gap-4 items-end mb-6">
    <div class="flex flex-col">
      <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“… ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input type="date" name="date" value="{{ selected_date }}" class="border border-gray-300 rounded px-3 py-2 focus:ring focus:ring-blue-200">
    </div>

    <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition">
      ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±
    </button>
  </form>

  <!-- âœ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
  <div class="space-y-6">
    {% for order in orders %}
      <div class="border border-gray-200 rounded-lg shadow-sm p-5 bg-gray-50 hover:shadow-md transition-all">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700">

          <p><strong>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ order.customer_name }} <span class="text-gray-500 text-xs">({{ order.customer_phone }})</span></p>
          <p><strong>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº:</strong> {{ order.invoice_amount|default:"-" }} Ø±ÙŠØ§Ù„</p>
          <p><strong>ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨:</strong> {{ order.details }}</p>
          <p><strong>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> {{ order.customer_location|default:"ØºÙŠØ± Ù…ØªÙˆÙØ±" }}</p>
          <p><strong>ğŸª Ø§Ù„Ù…ØªØ¬Ø±:</strong> {{ order.store.name }} <span class="text-gray-500 text-xs">({{ order.store.user.get_full_name|default:order.store.user.username }})</span></p>
          <p><strong>â° ÙˆÙ‚Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…:</strong> {{ order.created_at|date:"Y-m-d H:i" }}</p>
        </div>

        {% if order.customer_latitude and order.customer_longitude and order.store_latitude and order.store_longitude %}
          <button onclick="showMap({{ order.id }})"
                  class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm transition">
            ğŸ—ºï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
          </button>
        {% else %}
          <p class="text-yellow-600 text-sm mt-4">âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©: Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.</p>
        {% endif %}
      </div>
    {% empty %}
      <p class="text-center text-gray-500 text-sm mt-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙˆØµÙ„Ø© Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>
    {% endfor %}
  </div>
</div>

<!-- âœ… Modal Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div id="map-modal"
     class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl p-4 relative">
    <button onclick="closeMapModal()" class="absolute top-2 left-2 text-gray-600 hover:text-black text-xl">âœ•</button>
    <h3 class="text-lg font-semibold mb-3 text-gray-800">ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø·Ù„Ø¨</h3>
    <div id="map-container" class="h-72 rounded border"></div>
  </div>
</div>

<!-- âœ… JavaScript: Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø·Ù„Ø¨ -->
<script>
  function showMap(orderId) {
    const order = window.ordersData[orderId];
    if (!order) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ù„Ø¨");

    document.getElementById("map-modal").classList.remove("hidden");

    if (window.mapInstance) {
      window.mapInstance.remove();
    }

    const map = L.map("map-container").setView([order.customer_latitude, order.customer_longitude], 13);
    window.mapInstance = map;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const clientIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/535/535239.png",
      iconSize: [30, 30],
      iconAnchor: [15, 30],
    });

    const storeIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/891/891462.png",
      iconSize: [30, 30],
      iconAnchor: [15, 30],
    });

    L.marker([order.customer_latitude, order.customer_longitude], { icon: clientIcon })
      .addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„");

    L.marker([order.store_latitude, order.store_longitude], { icon: storeIcon })
      .addTo(map).bindPopup("ğŸª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ØªØ¬Ø±");
  }

  function closeMapModal() {
    document.getElementById("map-modal").classList.add("hidden");
  }

  // âœ… ØªÙ…Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ù„Ù‰ JavaScript
  window.ordersData = {
    {% for order in orders %}
      {{ order.id }}: {
        customer_latitude: {{ order.customer_latitude|default:"null" }},
        customer_longitude: {{ order.customer_longitude|default:"null" }},
        store_latitude: {{ order.store_latitude|default:"null" }},
        store_longitude: {{ order.store_longitude|default:"null" }},
      },
    {% endfor %}
  };
</script>
{% endblock %}
