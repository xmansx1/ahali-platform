{% extends "core/base.html" %}
{% block title %}Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white rounded-xl shadow p-6">
  <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2>

  {% if messages %}
    {% for msg in messages %}
      <div class="bg-green-100 text-green-800 px-4 py-2 rounded text-sm mb-4 shadow">
        {{ msg }}
      </div>
    {% endfor %}
  {% endif %}

  <form method="POST" class="space-y-4">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block mb-1 text-sm text-gray-700">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„</label>
        {{ form.first_name }}
        {% if form.first_name.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.first_name.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block mb-1 text-sm text-gray-700">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</label>
        {{ form.last_name }}
        {% if form.last_name.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.last_name.errors.0 }}</p>
        {% endif %}
      </div>
    </div>

    <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div>
      <label class="block mb-1 text-sm text-gray-700">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      {{ form.username }}
      {% if form.username.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.username.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ -->
    <div>
      <label class="block mb-1 text-sm text-gray-700">ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      {{ form.email }}
      {% if form.email.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.email.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ -->
    <div>
      <label class="block mb-1 text-sm text-gray-700">ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
      {{ form.phone_number }}
      {% if form.phone_number.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.phone_number.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div>
      <label class="block mb-1 text-sm text-gray-700">ğŸ‘¥ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      {{ form.user_type }}
      {% if form.user_type.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.user_type.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
    <div>
      <label class="block mb-1 text-sm text-gray-700">ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      {{ form.password }}
      {% if form.password.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.password.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
    <div>
      <label class="block mb-1 text-sm text-gray-700">ğŸ” ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      {{ form.confirm_password }}
      {% if form.confirm_password.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.confirm_password.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div class="flex items-center gap-2">
      {{ form.is_active }}
      <label class="text-sm text-gray-700">âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
    </div>

    <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø¬Ø± -->
    <div id="merchant-fields" style="display: none;">
      <div>
        <label class="block mb-1 text-sm text-gray-700">ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØ¬Ø±</label>
        {{ form.store_location }}
        {% if form.store_location.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.store_location.errors.0 }}</p>
        {% endif %}
      </div>

      <div class="mt-4">
        <label class="block mb-1 text-sm text-gray-700">ğŸ—ºï¸ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ØªØ¬Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
        <div id="map" class="h-64 rounded border shadow my-2"></div>
      </div>

      {{ form.store_latitude }}
      {{ form.store_longitude }}
    </div>

    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded font-medium transition">
      ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    </button>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const userTypeSelect = document.querySelector('[name="user_type"]');
  const merchantFields = document.getElementById("merchant-fields");
  const latInput = document.querySelector('[name="store_latitude"]');
  const lngInput = document.querySelector('[name="store_longitude"]');

  function toggleMerchantFields() {
    if (userTypeSelect.value === "merchant") {
      merchantFields.style.display = "block";
      setTimeout(() => map.invalidateSize(), 200);
    } else {
      merchantFields.style.display = "none";
      latInput.value = "";
      lngInput.value = "";
    }
  }

  userTypeSelect.addEventListener("change", toggleMerchantFields);
  toggleMerchantFields();

  const map = L.map("map").setView([24.7136, 46.6753], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const marker = L.marker([24.7136, 46.6753], { draggable: true }).addTo(map);
  marker.on("dragend", function (e) {
    const { lat, lng } = marker.getLatLng();
    latInput.value = lat.toFixed(6);
    lngInput.value = lng.toFixed(6);
  });
});
</script>
{% endblock %}
