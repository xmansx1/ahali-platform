{% load order_extras %}
<!-- âœ… ØªÙ†Ø¨ÙŠÙ‡ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ« -->
<div id="update-success-message"
     class="hidden mb-4 text-sm text-green-800 bg-green-100 border border-green-200 rounded-lg px-4 py-2 transition-all duration-300">
  ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­ âœ…
</div>

<div id="orders-list">
  {% for order in orders %}
    <div class="order-card bg-white border border-gray-200 rounded-xl shadow-md p-5 mb-6 hover:shadow-lg transition-all duration-300 relative"
         data-order-id="{{ order.id }}"
         data-customer-lat="{{ order.latitude }}"
         data-customer-lng="{{ order.longitude }}"
         data-store-lat="{{ order.store.latitude|default:"0" }}"
         data-store-lng="{{ order.store.longitude|default:"0" }}">

      <!-- âœ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700 leading-relaxed">
        <p>
          <strong>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> {{ order.customer_name }}
          {% if order.customer_phone %}
            | <a href="https://wa.me/{{ order.customer_phone|whatsapp_number }}" target="_blank"
                 class="text-green-600 hover:underline">ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬</a>
          {% endif %}
        </p>

        <p><strong>ğŸ“¦ Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØµÙŠÙ„:</strong> {{ order.get_delivery_type_display }}</p>
        <p><strong>ğŸ›’ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:</strong> {{ order.details }}</p>

        <p>
          <strong>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong>
          {% if order.customer_location %}
            {{ order.customer_location }}
            {% if order.latitude and order.longitude %}
              <a href="https://maps.google.com/?q={{ order.latitude }},{{ order.longitude }}" target="_blank"
                 class="text-blue-600 hover:underline ml-1">Ø§Ù†ØªÙ‚Ù„ â†—</a>
            {% endif %}
          {% else %}
            <span class="text-gray-400">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
          {% endif %}
        </p>

        {% if order.invoice_amount %}
          <p><strong>ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº:</strong> {{ order.invoice_amount }} Ø±ÙŠØ§Ù„</p>
        {% endif %}

        <p>
          <strong>ğŸ“Œ Ø§Ù„Ø­Ø§Ù„Ø©:</strong>
          <span class="inline-block px-2 py-1 rounded-full text-xs font-bold
            {% if order.status == 'preparing' %} bg-yellow-100 text-yellow-800
            {% elif order.status == 'delivering' %} bg-blue-100 text-blue-800
            {% elif order.status == 'delivered' %} bg-green-100 text-green-800
            {% elif order.status == 'canceled' %} bg-red-100 text-red-800
            {% elif order.status == 'deleted' %} bg-gray-300 text-gray-800
            {% endif %}">{{ order.get_status_display }}</span>
        </p>

        {% if order.assigned_to %}
          <p>
            <strong>ğŸš´â€â™‚ï¸ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</strong>
            {{ order.assigned_to.get_full_name|default:order.assigned_to.username }}
            {% if order.assigned_to.phone_number %}
              | {{ order.assigned_to.phone_number }}
              <a href="https://wa.me/{{ order.assigned_to.phone_number|whatsapp_number }}" target="_blank"
                 class="text-green-600 hover:underline ml-1">ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬</a>
            {% else %}
              <span class="text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…</span>
            {% endif %}
          </p>
        {% endif %}
      </div>

      <!-- âœ… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
      <div class="flex flex-col md:flex-row items-start md:items-center gap-4 mt-6 border-t pt-4">
        <button onclick="showOrderDetails({{ order.id }})"
                class="text-sm text-blue-600 hover:underline transition">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ â†’</button>

        <form method="post" action="{% url 'update_order_status' order.id %}" class="flex flex-wrap gap-3 items-center">
          {% csrf_token %}

          <select name="status"
                  class="status-select border border-gray-300 rounded px-3 py-2 text-sm"
                  data-order-id="{{ order.id }}">
            {% if order.status != 'preparing' %}
              <option value="preparing">Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
            {% endif %}
            {% if order.status != 'delivering' %}
              <option value="delivering">Ù‚ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠÙ„</option>
            {% endif %}
            {% if order.status != 'delivered' %}
              <option value="delivered">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
            {% endif %}
            {% if order.status != 'canceled' %}
              <option value="canceled">Ù…Ù„ØºÙŠ</option>
            {% endif %}
            {% if order.status != 'deleted' %}
              <option value="deleted">Ù…Ø­Ø°ÙˆÙ</option>
            {% endif %}
            <!-- âœ… Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØªØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
            <option value="{{ order.status }}" selected disabled hidden>ğŸŸ¢ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {{ order.get_status_display }}</option>

          </select>

          <input type="number"
                 step="0.01"
                 name="invoice_amount"
                 id="invoice-{{ order.id }}"
                 class="invoice-input border border-gray-300 rounded px-3 py-2 text-sm {% if order.status != 'delivering' %}hidden{% endif %}"
                 placeholder="Ù…Ø¨Ù„Øº Ø§Ù„ÙØ§ØªÙˆØ±Ø©"
                 {% if order.status == 'delivering' %}required{% endif %}>

          <button type="submit"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition">ØªØ­Ø¯ÙŠØ«</button>
        </form>
      </div>
    </div>
  {% empty %}
    <p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
  {% endfor %}
</div>

<!-- âœ… ÙƒÙˆØ¯ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª + Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
<script>
  window.updateOrdersData = function () {
    window.ordersData = {};
    document.querySelectorAll('[data-order-id]').forEach(card => {
      const id = card.dataset.orderId;
      const lat = parseFloat(card.dataset.customerLat);
      const lng = parseFloat(card.dataset.customerLng);
      const storeLat = parseFloat(card.dataset.storeLat);
      const storeLng = parseFloat(card.dataset.storeLng);

      if (!isNaN(lat) && !isNaN(lng)) {
        window.ordersData[id] = {
          customer_latitude: lat,
          customer_longitude: lng,
          store_latitude: storeLat,
          store_longitude: storeLng,
        };
      }
    });
  };

  window.updateOrdersData();

  // âœ… Ø¥Ø®ÙØ§Ø¡ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
  const msg = document.getElementById("update-success-message");
  if (msg && !msg.classList.contains("hidden")) {
    setTimeout(() => {
      msg.classList.add("hidden");
    }, 5000);
  }
</script>
